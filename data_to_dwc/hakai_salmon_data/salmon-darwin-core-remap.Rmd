---
title: "Darwin Core Salmon Data Remap"
author: "Brett Johnson"
date: '`r date()`'
output:
 html_document:
   theme: cosmo
   code_folding: show
   toc: true
   toc_float: true
   number_sections: true
---


```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(tidyverse)
library(here)
library(lubridate)
library(robis)
library(uuid)

# Read in Hakai Salmon Program Data
survey_data <- read_csv( "https://raw.githubusercontent.com/HakaiInstitute/jsp-data/master/data/survey_data.csv") %>% 
  select(survey_id, survey_date)

seine_data <- read_csv("https://raw.githubusercontent.com/HakaiInstitute/jsp-data/master/data/seine_data.csv") %>% 
  select(seine_id, survey_id, lat, long, set_time, so_total, pi_total, cu_total, 
         co_total, he_total, ck_total)

fish_lab_data <- read_csv(
  "https://raw.githubusercontent.com/HakaiInstitute/jsp-data/master/data/fish_lab_data.csv") %>% 
  select(ufn, weight, fork_length, quality_flag)

fish_field_data <- read_csv(
  "https://raw.githubusercontent.com/HakaiInstitute/jsp-data/master/data/fish_field_data.csv") %>% 
  select(ufn, semsp_id, seine_id, species, fork_length_field, weight_field)

sealice_time_series <- read_csv("https://raw.githubusercontent.com/HakaiInstitute/jsp-time-series/master/data/sealice_time_series.csv") %>% 
  select(ufn, louse_species, n_lice) %>% 
  spread(louse_species, n_lice) %>% 
  select(ufn, motile_caligus, motile_lep)


# Comnbine fish lab and fish field data
fish_data <- left_join(fish_field_data, fish_lab_data) %>% 
  left_join(sealice_time_series) %>% 
  mutate(occurrenceID = paste("hakai", "jsp", ufn, sep = "-"))


rm(fish_field_data, fish_lab_data, sealice_time_series)
```

# Intro

The Darwin Core Event Core consists of three tables: Events, Occurrences, and Measurements or Facts.


```{r event}

event <- tibble(eventID = seine_data$seine_id,
                eventDate = date(seine_data$set_time),
                decimalLatitude = seine_data$lat,
                decimalLongitude = seine_data$long,
                basisOfRecord = "HumanObservation",
                geodeticDatum = "EPSG:4326 WGS84",
                minimumDepthInMeters = 0,
                maximumDepthInMeters = 9,
                samplingProtocol = " http://dx.doi.org/10.21966/1.566666" # This is the DOI for the Hakai Salmon Data Package that contains the sanpling protocol
               )

write_csv(event, here::here("data_to_dwc", "hakai_salmon_data", "event.csv"))
```

```{r occurrence}

occurrence <- tibble(occurenceID = fish_data$occurrenceID,
                    organismID = fish_data$ufn,
                    scientificName = fish_data$species,
                    eventID = fish_data$seine_id,
                    occurenceStatus = "present")


# create taxonomic classification using WoRMS
species <- factor(fish_data$species)

# Change species names to full Scientific names 
latin <- fct_recode(occurrence$scientificName, "Oncorhynchus nerka" = "SO", "Oncorhynchus gorbuscha" = "PI", "Oncorhynchus keta" = "CU", "Oncorhynchus kisutch" = "CO", "Clupea pallasii" = "HE", "Oncorhynchus tshawytscha" = "CK")

occurrence$scientificName <- latin


# I went directly to the WoRMS webite (http://www.marinespecies.org/) to download the full taxonomic levels for the salmon species I have and put the WoRMS output (species_matched.xls) table in this project

species_matched <- readxl::read_excel(here::here("data", "species_matched.xls"))

occurrence <- left_join(occurrence, species_matched, by = c("scientificName" = "ScientificName...1"))

write_csv(occurrence, here::here("data_to_dwc", "hakai_salmon_data", "occurrence.csv"))

rm(species_matched)
```


To convert all your measurements or facts from your normal format to Darwin Core you essentially need to put all your measurements into one column called measurementType and a corresponding column called MeasurementValue. Here I convert length, and weight measurements that relate to an event and an occurrence. Species of salmon that are caught with each seine relate only to the event.

```{r measurementOrFact}

# First I tidy the fish abundance data into a long format so that it is a measurement that relates to an event
fish_abund <- seine_data %>% 
  gather(`so_total`, `pi_total`, `cu_total`, `co_total`, `he_total`, `ck_total`, key = measurementType, value = measurementValue) %>% 
  drop_na(measurementValue) %>% 
  select(eventID = seine_id, measurementType, measurementValue) %>% 
  mutate(occurrenceID = "NA") %>% 
  select(eventID, occurrenceID, measurementType, measurementValue) %>% 
  mutate(measurementUnit = "NA",
         measurementUnitID = "NA")

fish_abund$measurementType <- factor(fish_abund$measurementType) %>% 
  recode(so_total = "sockeyeCount",
         pi_total = "pinkCount",
         cu_total = "chumCount",
         co_total = "cohoCount",
         he_total = "herringCount",
         ck_total = "chinookCount"
  )

fish_length <- fish_data %>% 
  select(eventID = seine_id, occurrenceID, fork_length) %>% 
  mutate(measurementType = "length", measurementValue = fork_length) %>% 
  select(eventID, occurrenceID, measurementType, measurementValue) %>% 
  mutate(measurementUnit = "millimeters",
         measurementUnitID = "NA")

fish_weight <- fish_data %>% 
  select(eventID = seine_id, occurrenceID, weight) %>% 
  mutate(measurementType = "weight", measurementValue = weight) %>% 
  select(eventID, occurrenceID, measurementType, measurementValue) %>% 
  mutate(measurementUnit = "grams",
         measurementUnitID = "NA")

measurementOrFact <- bind_rows(fish_abund, fish_length, fish_weight)

rm(fish_abund, fish_length, fish_weight, seine_data, survey_data)

write_csv(measurementOrFact, here::here("data_to_dwc", "hakai_salmon_data", "measurementOrFact.csv"))
```

#TODO: use concatenated metadata for occurrenceID
