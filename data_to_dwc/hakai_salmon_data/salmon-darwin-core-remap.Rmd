---
title: "Darwin Core Salmon Data Remap"
author: "Brett Johnson"
date: "`r date()`"
output:
  html_document:
    code_folding: show
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(tidyverse)
library(here)
library(lubridate)

survey_data <- read_csv(here::here("data_to_dwc", "hakai_salmon_data", "raw_data", "survey_data.csv")) 

seine_data <- read_csv(here::here("data_to_dwc", "hakai_salmon_data", "raw_data", "seine_data.csv")) 

survey_seines <- right_join(survey_data, seine_data, by = "survey_id")

fish_data <- read_csv(here::here("data_to_dwc", "hakai_salmon_data", "raw_data", "fish_data.csv"), guess_max = 20000)

```

# Intro

One of the goals of the Hakai Institute and the Canadian Integrated Ocean Observing System (CIOOS) is to facilitate Open Science and FAIR (findable, accessible, interoperable, reusable) ecological and oceanographic data. In a concerted effort to adopt or establish how best to do that, several Hakai and CIOOS staff attended an International Ocean Observing System (IOOS) Code Sprint in Ann Arbour, Michigan between October 7--11, 2019, to discuss how to implement FAIR data principles for biological data collected in the marine environment. 

The [Darwin Core](https://dwc.tdwg.org) is a highly structured data format that standardizes data table relations, vocabularies, and defines field names. The Darwin Core defines three table types: `event`, `occurrence`, and `measurementOrFact`. This intuitively captures the way most ecologists conduct their research. Typically, a survey (event) is conducted and measurements, counts, or observations (collectively measurementOrFacts) are made regarding a specific habitat or species (occurrence). 

In the following script I demonstrate how I go about converting a subset of the data collected from the Hakai Institute Juvenile Salmon Program and discuss challenges, solutions, pros and cons, and when and what's worthwhile to convert to Darwin Core.

The conversion of a dataset to Darwin Core is much easier if your data are already tidy (normalized) in which you represent your data in separate tables that reflect the hierarchical and related nature of your observations. If your data are not already in a consistent and structured format, the conversion would likely be very arduos and not intuitive.

# event 

The first step is to consider what you will define as an event in your data set. I defined the capture of fish using a purse seine net as the `event`. Therefore, each row in the `event` table is one deployment of a seine net and is assigned a unique `eventID`. 

My process for conversion was to make a new table called `event` and map the standard Darwin Core column names to pre-existing columns that serve the same purpose in my original `seine_data` table and populate the other required fields.


```{r event}

event <- tibble(eventID = survey_seines$seine_id,
                eventDate = date(survey_seines$survey_date),
                decimalLatitude = survey_seines$lat,
                decimalLongitude = survey_seines$long,
                geodeticDatum = "EPSG:4326 WGS84",
                minimumDepthInMeters = 0,
                maximumDepthInMeters = 9, # seine depth is 9 m
                samplingProtocol = "http://dx.doi.org/10.21966/1.566666" # This is the DOI for the Hakai Salmon Data Package that contains the smnpling protocol, as well as the complete data package
               ) 

write_csv(event, here::here("data_to_dwc", "hakai_salmon_data", "event.csv"))
```


# occurrence

Next you'll want to determine what constitutes an occurrence for your data set. Because each event caputers fish, I consider each fish to be an occurrence. Therefore, the unit of observation (each row) in the occurrence table is a fish. To link each occurence to an event you need to include the `eventID` column for every occurrence so that you know what seine (event) each fish (occurrence) came from. You must also provide a globally unique identifier for each occurrence. I already have a locally unique identifier for each fish in the original `fish_data` table called `ufn`. To make it globally unique I pre-pend the organization and research program metadata to the `ufn` column. 

```{r occurrence}

# Create a globally unique occurence ID which in this case is simply a concatentation of metadata and the original, but not globally unique, `ufn` column
fish_data <- fish_data %>%
  mutate(occurrenceID = paste("hakai", "jsp", ufn, sep = "-"))

occurrence <- tibble(occurrenceID = fish_data$occurrenceID,
                    basisOfRecord = "HumanObservation",
                    scientificName = fish_data$species,
                    eventID = fish_data$seine_id,
                    occurenceStatus = "present")
```

For each occuerence of the six different fish species that I caught I need to match the species name that I provide with the official `scientificName` that is part of the World Register of Marine Species database http://www.marinespecies.org/

```{r}

# create taxonomic classification using WoRMS
species <- factor(fish_data$species)

# Change species names to full Scientific names 
latin <- fct_recode(occurrence$scientificName, "Oncorhynchus nerka" = "SO", "Oncorhynchus gorbuscha" = "PI", "Oncorhynchus keta" = "CU", "Oncorhynchus kisutch" = "CO", "Clupea pallasii" = "HE", "Oncorhynchus tshawytscha" = "CK") %>% 
  as.character()

occurrence$scientificName <- latin

# I went directly to the WoRMS webite (http://www.marinespecies.org/) to download the full taxonomic levels for the salmon species I have and put the WoRMS output (species_matched.xls) table in this project directory which is read in below and joined with the occurrence table

species_matched <- readxl::read_excel(here::here("data_to_dwc", "hakai_salmon_data", "raw_data", "species_matched.xls"))

occurrence <- left_join(occurrence, species_matched, by = c("scientificName" = "ScientificName"))

write_csv(occurrence, here::here("data_to_dwc", "hakai_salmon_data", "occurrence.csv"))

```


# measurementOrFact
To convert all your measurements or facts from your normal format to Darwin Core you essentially need to put all your measurements into one column called measurementType and a corresponding column called MeasurementValue. This standardizes the column names are in the `measurementOrFact` table. There are a number of predefined `measurementType`s listed on the [NERC](https://www.bodc.ac.uk/resources/vocabularies/) database that should be used where possible. I found it difficult to navigate this page to find the correct `measurementType`. So in some cases I made up my own. This is wehere things get messy and break down a bit. For example, I found a generic `abundance` NERC vocab term but it was not species specific. Because the species counts I use only relate to an event, and not an occurrence there would be no way to tell what species the count relates to. I see other `measurementTypes` in the NERC vocab that are species specific, however, the species abundances I wanted to list are not a term yet. I understand it is possible that have specific `measurementTypes` added to the NERC vocab, but without a clear consensus among salmon resarchers to decide on `measurementType` names it doesn't make sensse for the individual to propose new vocabulary. 

Here I convert length, and weight measurements that relate to an event and an occurrence and call those `measurementTypes` as `length` and `weight`. Species of salmon that are caught with each seine relate only to the event. I defined the `measurementType` as `sppCount`.

```{r measurementOrFact}

# First I tidy the fish abundance data into a long format so that it is a measurement that relates to an event
fish_abund <- seine_data %>% 
  gather(`so_total`, `pi_total`, `cu_total`, `co_total`, `he_total`, `ck_total`, key = measurementType, value = measurementValue) %>% 
  drop_na(measurementValue) %>% 
  select(eventID = seine_id, measurementType, measurementValue) %>% 
  mutate(occurrenceID = "NA") %>% 
  select(eventID, occurrenceID, measurementType, measurementValue) %>% 
  mutate(measurementUnit = "NA",
         measurementUnitID = "NA")

fish_abund$measurementType <- factor(fish_abund$measurementType) %>% 
  recode(so_total = "sockeyeCount",
         pi_total = "pinkCount",
         cu_total = "chumCount",
         co_total = "cohoCount",
         he_total = "herringCount",
         ck_total = "chinookCount"
  )

fish_length <- fish_data %>% 
  select(eventID = seine_id, occurrenceID, fork_length) %>% 
  mutate(measurementType = "length", measurementValue = fork_length) %>% 
  select(eventID, occurrenceID, measurementType, measurementValue) %>% 
  mutate(measurementUnit = "millimeters",
         measurementUnitID = "NA")

fish_weight <- fish_data %>% 
  select(eventID = seine_id, occurrenceID, weight) %>% 
  mutate(measurementType = "weight", measurementValue = weight) %>% 
  select(eventID, occurrenceID, measurementType, measurementValue) %>% 
  mutate(measurementUnit = "grams",
         measurementUnitID = "NA")

measurementOrFact <- bind_rows(fish_abund, fish_length, fish_weight)

rm(fish_abund, fish_length, fish_weight, seine_data)

write_csv(measurementOrFact, here::here("data_to_dwc", "hakai_salmon_data", "measurementOrFact.csv"))
```

```{r}
test <- anti_join(event, occurrence)
```
